<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Devastator Mission Control Centre</title>

    <!-- JQUERY -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <!-- BOOTSTRAP -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

    <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script type="text/javascript">
      var parameters = { src: "rtmp://" + window.location.hostname + "/rtmp/live" };

      swfobject.embedSWF
      ( "/static/StrobeMediaPlayback.swf"
      , "strobeMediaPlayback"
      , 640
      , 480
      , "10.1.0"
      , {}
      , parameters
      , { allowFullScreen: "true"}
      , { name: "strobeMediaPlayback" }
      );
    </script>
    <script>
        "use strict";

        var log = {
          info: function(msg) {
            d3.select("#logWindow").append("div").text(msg);
          }
        }

        function Joystick(svg) {
          this.svg = svg;
          this.pos = undefined;
          this.center = undefined;
          this.circle = undefined;
          this.touch = undefined;
          this.diameter = 100;
        }

        Joystick.prototype.constructor = Joystick;

        Joystick.prototype.start = function(pos) {
          this.pos = pos;
          this.center = this.svg.append("circle")
            .attr("cx", pos[0])
            .attr("cy", pos[1])
            .attr("r", 2)
          ;

          this.circle = this.svg.append("circle")
            .attr("cx", pos[0])
            .attr("cy", pos[1])
            .attr("r", this.diameter)
            .attr("fill", "green")
            .attr("fill-opacity", 0.3)
            .attr("stroke", "black")
            .attr("stroke-width", 4)
            .attr("stroke-opacity", 0.6)
          ;

          this.touch = this.svg.append("circle")
            .attr("cx", pos[0])
            .attr("cy", pos[1])
            .attr("r", 5)
          ;


          var joystick = this
          this.svg.on("mousemove", function() {
            joystick.update(d3.mouse(this))
          });
        }


        Joystick.prototype.update = function(pos) {
          var dx = this.pos[0] - pos[0];
          var dy = this.pos[1] - pos[1];
          var r = Math.sqrt(dx*dx + dy*dy);
          if (r > this.diameter) {
            var factor = r / this.diameter;
            dx = dx / factor;
            dy = dy / factor;
          }
          this.touch
            .attr("cx", this.pos[0] - dx)
            .attr("cy", this.pos[1] - dy)
          ;
        }


        Joystick.prototype.stop = function() {
          this.center.remove();
          this.circle.remove();
          this.touch.remove();
          this.svg.on("mousemove", null);
        }



        $(function() {
          log.info("started!");
          var svg = d3.select("#controls");
          var joystick = new Joystick(svg);
          svg
            .on("mousedown", function() {
              joystick.start(d3.mouse(this));
            })
            .on("mouseup", function() {
              joystick.stop();
            })
          ;
        })
    </script>
  </head>

  <body>
    <div class="page-header">
      <h1>Devastator 2.0 <small>Exterminate! Exterminate!</small></h1>
    </div>
    <button id="CamReset" type="button" class="btn btn-default">Reset cam position</button>
<!--     <div id="strobeMediaPlayback">
      <p>Here supposed to be a video player. Flash blocked or not supported?</p>
    </div>
 -->    <br>
    <svg id="controls" width="320" height="240" style="border:solid black 1px; background-color: red;">
    </svg>
   <div id="logWindow" style="border:solid black 1px; background-color: grey; height: 10em; width: 20em;"></div>
  </body>
</html>
